import { App } from '../core/App.js';
import { el } from '../utils/dom.js';
import { VERSION, BUILD } from '../version.js';
import { getThemeMode, applyThemeMode } from '../theme/theme.js';

const WALLPAPER_KEY = 'yamanos_wallpaper';
const GRID_STORAGE_KEY = 'yamanos_mobile_grid_v8';
const DOCK_STORAGE_KEY = 'yamanos_dock_items';
const FOLDER_SEED_KEY = 'yamanos_mobile_seed_v06';
const HOME_LAYOUT_MODE_KEY = 'yamanos_home_layout_mode';
const HOME_LAYOUT_APPLIED_KEY = 'yamanos_home_layout_v100';

function getBrowserPrefs() {
  const defaults = {
    searchEngine: localStorage.getItem('yamanosSearchEngine') || 'google',
    forceWebParam: true,
    historyLimit: 20,
    startTheme: 'aurora',
  };

  const stored = readJson(BROWSER_PREFS_KEY, {});
  const historyLimit = Number(stored.historyLimit);
  const clampedHistory = Number.isFinite(historyLimit)
    ? Math.max(10, Math.min(100, Math.round(historyLimit)))
    : defaults.historyLimit;

  return {
    searchEngine: ['google', 'duck', 'bing'].includes(stored.searchEngine) ? stored.searchEngine : defaults.searchEngine,
    forceWebParam: typeof stored.forceWebParam === 'boolean' ? stored.forceWebParam : defaults.forceWebParam,
    historyLimit: clampedHistory,
    startTheme: ['aurora', 'graphite', 'midnight'].includes(stored.startTheme) ? stored.startTheme : defaults.startTheme,
  };
}

function setBrowserPrefs(nextPrefs) {
  const sanitized = {
    searchEngine: ['google', 'duck', 'bing'].includes(nextPrefs?.searchEngine) ? nextPrefs.searchEngine : 'google',
    forceWebParam: nextPrefs?.forceWebParam !== false,
    historyLimit: Number.isFinite(Number(nextPrefs?.historyLimit))
      ? Math.max(10, Math.min(100, Math.round(Number(nextPrefs.historyLimit))))
      : 20,
    startTheme: ['aurora', 'graphite', 'midnight'].includes(nextPrefs?.startTheme) ? nextPrefs.startTheme : 'aurora',
  };
  localStorage.setItem(BROWSER_PREFS_KEY, JSON.stringify(sanitized));
  localStorage.setItem('yamanosSearchEngine', sanitized.searchEngine);
  window.dispatchEvent(new CustomEvent('yamanos:browser-settings-changed', { detail: sanitized }));
}

export class SettingsApp extends App {
  constructor(kernel, pid) {
    super(kernel, pid);
    this.metadata = { name: 'Settings', id: 'settings', icon: 'âš™ï¸' };
    this.state = { activeCategory: 'display' };
  }

  async init() {
    this.root = el('div', { class: 'app-window ys-settings-app' });

    const style = el('style', {}, `
      .ys-settings-app {
        display: flex;
        flex-direction: column;
        height: 100%;
        background: var(--glass-surface-3);
        color: var(--surface-text);
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        overflow: hidden;
      }

      .ys-wallpaper.selected {
        border-color: var(--glow-teal);
        box-shadow: 0 0 0 2px rgba(255,255,255,0.06), 0 10px 24px rgba(0,0,0,0.35);
      }

      .ys-wallpaper::after {
        content: "";
        position: absolute;
        top: 6px;
        right: 6px;
        width: 18px;
        height: 18px;
        border-radius: 999px;
        background: rgba(0,0,0,0.45);
        border: 1px solid rgba(255,255,255,0.18);
        opacity: 0;
        transform: scale(0.9);
        transition: opacity 120ms ease, transform 120ms ease;
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
      }

      .ys-wallpaper.selected::after {
        opacity: 1;
        transform: scale(1);
        background: var(--glow-teal);
        border-color: rgba(255,255,255,0.25);
      }

      .ys-wallpaper.selected::before {
        content: "âœ“";
        position: absolute;
        top: 5px;
        right: 10px;
        font-size: 12px;
        font-weight: 900;
        color: var(--surface-text);
        opacity: 1;
        z-index: 2;
        pointer-events: none;
      }

      .ys-sidebar {
        width: 100%;
        flex: 0 0 64px;
        flex-shrink: 0;
        min-height: 64px;
        max-height: 64px;
        background: rgba(10, 12, 18, 0.92);
        border-bottom: 1px solid rgba(255,255,255,0.08);
        display: flex;
        flex-direction: row;
        align-items: center;
        gap: 6px;
        padding: 10px 8px;
        overflow-x: auto;
        overflow-y: hidden;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
        z-index: 4;
      }

      .ys-sidebar::-webkit-scrollbar {
        display: none;
      }

      .ys-content {
        flex: 1;
        min-width: 0;
        min-height: 0;
        display: flex;
        flex-direction: column;
        background: rgba(0,0,0,0.25);
        overflow: hidden;
      }

      .ys-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        flex-shrink: 0;
        padding: 14px 20px;
        border-bottom: 1px solid rgba(255,255,255,0.08);
        background: rgba(12, 14, 20, 0.9);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        position: sticky;
        top: 0;
        z-index: 3;
      }

      .ys-title {
        font-size: 21px;
        font-weight: 700;
        letter-spacing: -0.2px;
      }

      .ys-scroll {
        flex: 1;
        min-height: 0;
        overflow-y: auto;
        padding: 16px 20px max(28px, env(safe-area-inset-bottom, 0px) + 20px);
        -webkit-overflow-scrolling: touch;
        overscroll-behavior: contain;
      }

      .ys-nav-item {
        border: 0;
        background: transparent;
        color: #a7a8ad;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex: 0 0 auto;
        gap: 10px;
        min-height: 42px;
        padding: 8px 14px;
        text-align: left;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        white-space: nowrap;
      }

      .ys-nav-item:active {
        opacity: 0.85;
      }

      .ys-nav-item.active {
        background: var(--glow-teal);
        color: var(--surface-text);
      }

      .ys-nav-icon {
        width: 20px;
        text-align: center;
        font-size: 16px;
      }

      .ys-group {
        margin-bottom: 20px;
      }

      .ys-group-title {
        color: #8f9198;
        font-size: 12px;
        font-weight: 700;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        padding-left: 4px;
        margin-bottom: 8px;
      }

      .ys-card {
        background: var(--glass-surface-2);
        border: 1px solid rgba(255,255,255,0.08);
        border-radius: 12px;
        overflow: hidden;
      }

      .ys-row,
      .ys-choice,
      .ys-action {
        border-bottom: 1px solid rgba(255,255,255,0.06);
      }

      .ys-row:last-child,
      .ys-choice:last-child,
      .ys-action:last-child {
        border-bottom: 0;
      }

      .ys-row,
      .ys-choice,
      .ys-action {
        min-height: 56px;
        padding: 12px 14px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }

      .ys-info {
        min-width: 0;
        flex: 1;
      }

      .ys-label {
        font-size: 15px;
        color: var(--surface-text);
      }

      .ys-desc {
        margin-top: 2px;
        color: #8f9198;
        font-size: 12px;
        line-height: 1.35;
      }

      .ys-toggle {
        border: 0;
        width: 50px;
        height: 30px;
        border-radius: 20px;
        background: rgba(255,255,255,0.18);
        position: relative;
        cursor: pointer;
        flex-shrink: 0;
      }

      .ys-toggle.on {
        background: #0a84ff;
      }

      .ys-toggle-knob {
        width: 26px;
        height: 26px;
        border-radius: 13px;
        background: var(--surface-text);
        position: absolute;
        top: 2px;
        left: 2px;
        transition: transform 0.2s ease;
      }

      .ys-toggle.on .ys-toggle-knob {
        transform: translateX(20px);
      }

      .ys-choice,
      .ys-action {
        border: 0;
        width: 100%;
        background: transparent;
        color: inherit;
        text-align: left;
        cursor: pointer;
      }

      .ys-choice {
        padding: 14px;
      }

      .ys-check {
        color: var(--glow-teal);
        font-weight: 700;
        font-size: 18px;
      }

      .ys-action .ys-label.is-danger {
        color: #ff453a;
      }

      .ys-chevron {
        color: #5f6168;
        font-size: 19px;
        line-height: 1;
      }

      .ys-btn {
        border: 0;
        background: var(--glass-surface-2);
        color: var(--glow-teal);
        border-radius: 10px;
        padding: 9px 14px;
        min-width: 88px;
        font-size: 14px;
        font-weight: 600;
        width: auto;
        white-space: nowrap;
        text-align: center;
      }

      .ys-btn:active {
        opacity: 0.8;
      }

      .ys-wallpaper-grid {
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: 8px;
      }

      .ys-wallpaper {
        border: 2px solid rgba(255,255,255,0.12);
        border-radius: 10px;
        height: 54px;
        position: relative;
        cursor: pointer;
        overflow: hidden;
      }

      .ys-wallpaper-label {
        position: absolute;
        left: 0;
        right: 0;
        bottom: 0;
        padding: 2px 4px;
        font-size: 9px;
        text-align: center;
        background: rgba(0,0,0,0.5);
      }

      .ys-about-hero {
        text-align: center;
        padding: 20px 0 14px;
      }

      .ys-about-logo {
        font-size: 52px;
        margin-bottom: 10px;
      }

      .ys-about-version {
        color: #8f9198;
        font-size: 14px;
        margin-top: 4px;
      }

      .ys-about-row {
        display: flex;
        justify-content: space-between;
        gap: 10px;
        padding: 12px 14px;
        border-bottom: 1px solid rgba(255,255,255,0.06);
      }

      .ys-about-row:last-child {
        border-bottom: 0;
      }

      .ys-about-key {
        color: var(--surface-text);
        font-size: 14px;
      }

      .ys-about-value {
        color: #9a9ca3;
        font-size: 14px;
        text-align: right;
        max-width: 62%;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .ys-legal {
        font-size: 12px;
        line-height: 1.5;
        color: #9a9ca3;
        padding: 14px;
      }

      .ys-legal p {
        margin: 0 0 8px;
      }

      .ys-legal p:last-child {
        margin-bottom: 0;
      }

      @media (max-width: 820px) {
        .ys-sidebar {
          min-height: 60px;
          max-height: 60px;
          gap: 6px;
          padding: 10px 8px;
        }

        .ys-nav-item {
          border-radius: 999px;
          background: var(--glass-surface-2);
          padding: 8px 11px;
          font-size: 13px;
        }

        .ys-nav-icon {
          width: auto;
          font-size: 14px;
        }

        .ys-header {
          padding: 12px 14px;
        }

        .ys-title {
          font-size: 18px;
        }

        .ys-scroll {
          padding: 12px 14px max(24px, env(safe-area-inset-bottom, 0px) + 18px);
        }

        .ys-wallpaper-grid {
          grid-template-columns: repeat(3, minmax(0, 1fr));
        }
      }

      @media (orientation: landscape) and (max-height: 520px) {
        .ys-sidebar {
          min-height: 56px;
          max-height: 56px;
          padding: 8px 8px;
        }

        .ys-nav-item {
          min-height: 38px;
          font-size: 14px;
          padding: 6px 12px;
        }

        .ys-header {
          padding: 10px 14px;
        }

        .ys-scroll {
          padding: 12px 14px max(20px, env(safe-area-inset-bottom, 0px) + 16px);
        }
      }
    `);

    this.root.appendChild(style);

    const sidebar = el('div', { class: 'ys-sidebar' });
    this.contentArea = el('div', { class: 'ys-content' });

    this.categories = [
      { id: 'display', label: 'Display', icon: 'ðŸŽ¨' },
      { id: 'homescreen', label: 'Home', icon: 'ðŸ“±' },
      { id: 'browser', label: 'Browser', icon: 'ðŸŒ' },
      { id: 'storage', label: 'Storage', icon: 'ðŸ’¾' },
      { id: 'accessibility', label: 'Access', icon: 'â™¿' },
      { id: 'about', label: 'About', icon: 'â„¹ï¸' },
    ];

    this.categories.forEach((cat) => {
      const btn = el('button', {
        type: 'button',
        class: `ys-nav-item ${this.state.activeCategory === cat.id ? 'active' : ''}`,
        onclick: () => {
          this.state.activeCategory = cat.id;
          this._updateSidebar(sidebar);
          this._renderContent();
        },
      }, [
        el('span', { class: 'ys-nav-icon' }, cat.icon),
        el('span', {}, cat.label),
      ]);
      sidebar.appendChild(btn);
    });

    this.sidebar = sidebar;
    this.root.append(sidebar, this.contentArea);
    this._renderContent();
  }

  _updateSidebar(sidebar) {
    Array.from(sidebar.children).forEach((child, i) => {
      const isActive = this.categories[i].id === this.state.activeCategory;
      child.classList.toggle('active', isActive);
      if (isActive && typeof child.scrollIntoView === 'function') {
        child.scrollIntoView({ block: 'nearest', inline: 'center', behavior: 'smooth' });
      }
    });
  }

  _renderContent() {
    this.contentArea.innerHTML = '';

    const titles = {
      display: 'Display & Wallpaper',
      homescreen: 'Home Screen',
      browser: 'Browser',
      storage: 'Storage & Data',
      accessibility: 'Accessibility',
      about: 'About YamanOS',
    };

    const header = el('div', { class: 'ys-header' }, [
      el('div', { class: 'ys-title' }, titles[this.state.activeCategory] || 'Settings'),
      el('button', { type: 'button', class: 'ys-btn', onclick: () => this.close() }, 'Done'),
    ]);

    const scroll = el('div', { class: 'ys-scroll' });

    switch (this.state.activeCategory) {
      case 'display':
        this._renderDisplay(scroll);
        break;
      case 'homescreen':
        this._renderHomeScreen(scroll);
        break;
      case 'browser':
        this._renderBrowser(scroll);
        break;
      case 'storage':
        this._renderStorage(scroll);
        break;
      case 'accessibility':
        this._renderAccessibility(scroll);
        break;
      case 'about':
        this._renderAbout(scroll);
        break;
      default:
        this._renderDisplay(scroll);
    }

    this.contentArea.append(header, scroll);
  }

  _renderDisplay(container) {
    const isDarkMode = getThemeMode() !== 'light';

    container.appendChild(this._group('Appearance', [
      this._toggleRow('Dark Mode', 'Use dark interface colors', isDarkMode, (nextOn) => {
        applyThemeMode(nextOn ? 'dark' : 'light');
      }),
    ]));

    const wallpapers = [
      { css: 'url("assets/wallpaper.png")', name: 'Default' },
      { css: 'url("assets/wallpapers/deep-blue.png")', name: 'Deep Blue' },
      { css: 'url("assets/wallpapers/black.png")', name: 'Black' },
      { css: 'url("assets/wallpapers/dark.png")', name: 'Dark' },
      { css: 'url("assets/wallpapers/violet.png")', name: 'Violet' },
      { css: 'url("assets/wallpapers/pink.png")', name: 'Pink' },
      { css: 'url("assets/wallpapers/sky.png")', name: 'Sky' },
      { css: 'url("assets/wallpapers/mint.png")', name: 'Mint' },
    ];

    const currentWallpaper = localStorage.getItem(WALLPAPER_KEY) || wallpapers[0].css;

    const grid = el('div', { class: 'ys-wallpaper-grid' });
    wallpapers.forEach((wp) => {
      const option = el('button', {
        type: 'button',
        class: 'ys-wallpaper' + (wp.css === currentWallpaper ? ' selected' : ''),
        style: `background:${wp.css}; background-size:cover; background-position:center;`,
      }, [el('div', { class: 'ys-wallpaper-label' }, wp.name)]);

      option.onclick = () => {
        const shell = document.getElementById('app-shell') || document.body;
        shell.style.background = wp.css;
        shell.style.backgroundSize = 'cover';
        shell.style.backgroundPosition = 'center';
        localStorage.setItem(WALLPAPER_KEY, wp.css);

        // Visual selection state
        grid.querySelectorAll('.ys-wallpaper.selected').forEach((el) => el.classList.remove('selected'));
        option.classList.add('selected');
      };

      grid.appendChild(option);
    });

    container.appendChild(this._group('Wallpaper', [grid]));
  }

  _renderHomeScreen(container) {
    container.appendChild(this._group('Icon Layout', [
      this._actionRow('Reset Icon Positions', 'Restore default layout sorted by type and name', () => {
        if (!confirm('Reset home screen layout? Icons will be rearranged.')) return;
        localStorage.removeItem(GRID_STORAGE_KEY);
        localStorage.removeItem(HOME_LAYOUT_APPLIED_KEY);
        localStorage.removeItem('yamanos_home_layout_v091_hotfix2');
        localStorage.setItem(HOME_LAYOUT_MODE_KEY, 'type-name');
        location.reload();
      }),
      this._actionRow('Reset Dock', 'Restore default dock items', () => {
        if (!confirm('Reset dock to defaults?')) return;
        localStorage.removeItem(DOCK_STORAGE_KEY);
        location.reload();
      }),
    ]));

    container.appendChild(this._group('Folders', [
      this._actionRow('Reset Folders', 'Re-seed default folders (AI, TV, Social, Games)', () => {
        if (!confirm('This will re-seed default folders on next reload.')) return;
        localStorage.removeItem(FOLDER_SEED_KEY);
        location.reload();
      }),
    ]));

    container.appendChild(this._group('Shortcuts', [
      this._infoRow('Tip', 'Long-press desktop background to add web shortcuts. Long-press any app for quick actions.'),
    ]));
  }

  _renderBrowser(container) {
    const prefs = getBrowserPrefs();
    const updatePrefs = (patch) => {
      setBrowserPrefs({ ...prefs, ...patch });
      this._renderContent();
    };

    container.appendChild(this._group('Search Engine', [
      this._choiceRow('Google', prefs.searchEngine === 'google', () => updatePrefs({ searchEngine: 'google' })),
      this._choiceRow('DuckDuckGo', prefs.searchEngine === 'duck', () => updatePrefs({ searchEngine: 'duck' })),
      this._choiceRow('Bing', prefs.searchEngine === 'bing', () => updatePrefs({ searchEngine: 'bing' })),
    ]));

    container.appendChild(this._group('Browsing Behavior', [
      this._infoRow('Open Links in New Tab', 'Always on for best compatibility (iframe embeds are blocked by many websites).'),
      this._toggleRow('Force Browser Mode', 'Append yamanos_web=1 to reduce native-app redirects', prefs.forceWebParam, (next) => {
        updatePrefs({ forceWebParam: next });
      }),
    ]));

    container.appendChild(this._group('Start Page Theme', [
      this._choiceRow('Aurora', prefs.startTheme === 'aurora', () => updatePrefs({ startTheme: 'aurora' })),
      this._choiceRow('Graphite', prefs.startTheme === 'graphite', () => updatePrefs({ startTheme: 'graphite' })),
      this._choiceRow('Midnight', prefs.startTheme === 'midnight', () => updatePrefs({ startTheme: 'midnight' })),
    ]));

    container.appendChild(this._group('History Limit', [
      this._choiceRow('20 entries', prefs.historyLimit === 20, () => updatePrefs({ historyLimit: 20 })),
      this._choiceRow('50 entries', prefs.historyLimit === 50, () => updatePrefs({ historyLimit: 50 })),
      this._choiceRow('100 entries', prefs.historyLimit === 100, () => updatePrefs({ historyLimit: 100 })),
    ]));

    container.appendChild(this._group('Privacy & Data', [
      this._actionRow('Clear Browsing History', 'Remove saved recent links', () => {
        if (!confirm('Clear browsing history?')) return;
        const state = readJson(BROWSER_STATE_KEY, {});
        state.history = [];
        localStorage.setItem(BROWSER_STATE_KEY, JSON.stringify(state));
        alert('Browsing history cleared.');
      }, true),
      this._actionRow('Clear Bookmarks', 'Remove saved bookmarks', () => {
        if (!confirm('Clear saved bookmarks?')) return;
        const state = readJson(BROWSER_STATE_KEY, {});
        state.bookmarks = [];
        localStorage.setItem(BROWSER_STATE_KEY, JSON.stringify(state));
        localStorage.removeItem(LEGACY_BOOKMARKS_KEY);
        alert('Bookmarks cleared.');
      }, true),
      this._actionRow('Reset Browser Settings', 'Restore browser defaults', () => {
        if (!confirm('Reset browser settings and data?')) return;
        localStorage.removeItem(BROWSER_STATE_KEY);
        localStorage.removeItem(LEGACY_BOOKMARKS_KEY);
        setBrowserPrefs({
          searchEngine: 'google',
          forceWebParam: true,
          historyLimit: 20,
          startTheme: 'aurora',
        });
        alert('Browser reset complete.');
      }, true),
    ]));
  }

  _renderStorage(container) {
    let totalKeys = 0;
    let totalSize = 0;
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      if (!key || !key.startsWith('yamanos')) continue;
      totalKeys += 1;
      totalSize += (localStorage.getItem(key) || '').length * 2;
    }

    const totalStorage = (() => {
      let bytes = 0;
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i) || '';
        const value = localStorage.getItem(key) || '';
        bytes += (key.length + value.length) * 2;
      }
      return (bytes / 1024).toFixed(1);
    })();

    container.appendChild(this._group('Local Storage', [
      this._dataRow('YamanOS Data', `${(totalSize / 1024).toFixed(1)} KB across ${totalKeys} keys`),
      this._dataRow('Total localStorage', `${totalStorage} KB used`),
    ]));

    container.appendChild(this._group('Data Management', [
      this._actionRow('Clear App Caches', 'Remove cached weather and browser data', () => {
        if (!confirm('Clear app caches?')) return;
        ['yamanos_browser_v1', 'yamanos_weather_v1'].forEach((k) => localStorage.removeItem(k));
        alert('Caches cleared.');
      }),
      this._actionRow('Export Settings', 'Download YamanOS keys as JSON', () => {
        const data = {};
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key?.startsWith('yamanos')) data[key] = localStorage.getItem(key);
        }
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const a = document.createElement('a');
        const objectUrl = URL.createObjectURL(blob);
        a.href = objectUrl;
        a.download = 'yamanos-settings.json';
        a.click();
        setTimeout(() => URL.revokeObjectURL(objectUrl), 0);
      }),
      this._actionRow('Reset YamanOS', 'Erase layout, settings, and app data', () => {
        if (!confirm('This will delete YamanOS data. Continue?')) return;
        if (!confirm('Are you absolutely sure? This cannot be undone.')) return;
        const prefixes = ['yamanos', 'desktop_', 'dock_'];
        const toRemove = [];
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i) || '';
          if (prefixes.some((p) => key.startsWith(p))) toRemove.push(key);
        }
        toRemove.forEach((k) => localStorage.removeItem(k));
        location.reload();
      }, true),
    ]));
  }

  _renderAccessibility(container) {
    const get24 = () => {
      try {
        return Boolean(JSON.parse(localStorage.getItem('yamanos_clock_v2') || '{}').use24h);
      } catch {
        return false;
      }
    };

    const getMetric = () => {
      try {
        return (JSON.parse(localStorage.getItem('yamanos_weather_v1') || '{}').unit || 'c') === 'c';
      } catch {
        return true;
      }
    };

    container.appendChild(this._group('Region & Format', [
      this._toggleRow('24-Hour Time', 'Use 24-hour clock format', get24(), (next) => {
        const data = readJson('yamanos_clock_v2', {});
        data.use24h = next;
        localStorage.setItem('yamanos_clock_v2', JSON.stringify(data));
        window.dispatchEvent(new CustomEvent('yamanos:clock_update'));
      }),
      this._toggleRow('Metric Units', 'Use Celsius for weather', getMetric(), (next) => {
        const data = readJson('yamanos_weather_v1', {});
        data.unit = next ? 'c' : 'f';
        localStorage.setItem('yamanos_weather_v1', JSON.stringify(data));
        window.dispatchEvent(new CustomEvent('yamanos:weatherchange'));
      }),
    ]));
  }

  _renderAbout(container) {
    const ua = navigator.userAgent;
    const isMobile = /Mobile|Android|iPhone|iPad/i.test(ua);
    const browserName = /Firefox/i.test(ua)
      ? 'Firefox'
      : /Edg/i.test(ua)
        ? 'Edge'
        : /Chrome/i.test(ua)
          ? 'Chrome'
          : /Safari/i.test(ua)
            ? 'Safari'
            : 'Browser';
    const platform = isMobile
      ? (/iPhone|iPad/i.test(ua) ? 'iOS/iPadOS' : 'Android')
      : (/Mac/i.test(ua) ? 'macOS' : /Win/i.test(ua) ? 'Windows' : /Linux/i.test(ua) ? 'Linux' : 'Desktop');

    container.appendChild(el('div', { class: 'ys-about-hero' }, [
      el('div', { class: 'ys-about-logo' }, 'ðŸ’Ž'),
      el('h2', { style: 'margin:0; font-size:25px;' }, 'YamanOS'),
      el('div', { class: 'ys-about-version' }, `Version ${VERSION} (Build ${BUILD})`),
    ]));

    container.appendChild(this._group('System Information', [
      this._aboutRow('Device Type', isMobile ? 'Mobile / Tablet' : 'Desktop'),
      this._aboutRow('Platform', platform),
      this._aboutRow('Browser', browserName),
      this._aboutRow('Screen', `${window.screen.width}Ã—${window.screen.height}`),
      this._aboutRow('Viewport', `${window.innerWidth}Ã—${window.innerHeight}`),
      this._aboutRow('Pixel Ratio', `${window.devicePixelRatio}x`),
      this._aboutRow('Touch', ('ontouchstart' in window) ? 'Supported' : 'Not Available'),
    ]));

    container.appendChild(this._group('Runtime', [
      this._aboutRow('Runtime', 'Browser (HTML5 + ES Modules)'),
      this._aboutRow('Storage', 'localStorage (on-device browser storage)'),
      this._aboutRow('Architecture', 'Mobile-first web shell'),
    ]));

    const legal = el('div', { class: 'ys-legal' }, [
      el('p', { style: 'font-weight:700; color:#fff;' }, 'Legal & Service Disclaimer'),
      el('p', {}, 'YamanOS is a browser-based interface and does not replace your device operating system. Behavior may vary by browser engine and version.'),
      el('p', {}, 'Data you create in YamanOS is saved locally in this browser profile unless a feature explicitly opens a third-party website.'),
      el('p', {}, 'Third-party services used by default features include Open-Meteo APIs (weather/geocoding/air-quality) and Google Favicons API. Their own terms and privacy policies apply.'),
      el('p', {}, 'Shortcuts and web apps can open external sites such as YouTube, Netflix, social platforms, and maps services. Those services are independent and govern their own accounts, content, and privacy handling.'),
      el('p', {}, 'YamanOS is an independent project and is not affiliated with or endorsed by Apple, Google, Microsoft, OpenAI, or other third-party brands shown in icons or shortcuts.'),
      el('p', { style: 'color:#73757d;' }, 'Â© 2026 Yaman Addas. All rights reserved.'),
    ]);

    container.appendChild(this._group('Legal', [legal]));
  }

  _group(title, children) {
    return el('section', { class: 'ys-group' }, [
      el('div', { class: 'ys-group-title' }, title),
      el('div', { class: 'ys-card' }, children),
    ]);
  }

  _toggleRow(label, desc, isOn, onToggle) {
    const row = el('div', { class: 'ys-row' });
    const info = el('div', { class: 'ys-info' }, [
      el('div', { class: 'ys-label' }, label),
      ...(desc ? [el('div', { class: 'ys-desc' }, desc)] : []),
    ]);

    const toggle = el('button', {
      type: 'button',
      class: `ys-toggle ${isOn ? 'on' : ''}`,
      'aria-pressed': String(isOn),
    }, [el('span', { class: 'ys-toggle-knob' })]);

    toggle.onclick = () => {
      const next = !toggle.classList.contains('on');
      toggle.classList.toggle('on', next);
      toggle.setAttribute('aria-pressed', String(next));
      onToggle(next);
    };

    row.append(info, toggle);
    return row;
  }

  _choiceRow(label, isSelected, onSelect) {
    return el('button', { type: 'button', class: 'ys-choice', onclick: onSelect }, [
      el('div', { class: 'ys-label' }, label),
      el('div', { class: 'ys-check', style: isSelected ? '' : 'visibility:hidden;' }, 'âœ“'),
    ]);
  }

  _actionRow(label, desc, action, isDanger = false) {
    return el('button', { type: 'button', class: 'ys-action', onclick: action }, [
      el('div', { class: 'ys-info' }, [
        el('div', { class: `ys-label ${isDanger ? 'is-danger' : ''}` }, label),
        ...(desc ? [el('div', { class: 'ys-desc' }, desc)] : []),
      ]),
      el('div', { class: 'ys-chevron' }, 'â€º'),
    ]);
  }

  _dataRow(label, value) {
    return el('div', { class: 'ys-row' }, [
      el('div', { class: 'ys-label' }, label),
      el('div', { class: 'ys-desc', style: 'margin-top:0; text-align:right;' }, value),
    ]);
  }

  _infoRow(label, text) {
    return el('div', { class: 'ys-row' }, [
      el('div', { class: 'ys-info' }, [
        el('div', { class: 'ys-label' }, label),
        el('div', { class: 'ys-desc' }, text),
      ]),
    ]);
  }

  _aboutRow(label, value) {
    return el('div', { class: 'ys-about-row' }, [
      el('div', { class: 'ys-about-key' }, label),
      el('div', { class: 'ys-about-value' }, value),
    ]);
  }
}